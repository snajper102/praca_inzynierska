{% extends 'base.html' %}

{% block title %}Live Monitor - {{ sensor.name }}{% endblock %}

{% block extra_css %}
<style>
  .live-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .live-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .live-title {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .live-title h1 {
    color: #f1f5f9;
    font-size: 2rem;
  }

  .pulse-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s ease-in-out infinite;
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
  }

  @keyframes pulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
    }
    50% {
      box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
    }
  }

  .refresh-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    color: #3b82f6;
    font-size: 0.9rem;
  }

  .main-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .live-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid #334155;
    border-radius: 1.5rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .live-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .live-card.updating::before {
    opacity: 1;
    animation: shimmer 1s ease-in-out;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .live-card:hover {
    transform: translateY(-8px);
    border-color: #3b82f6;
    box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
  }

  .live-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .live-icon.power { color: #3b82f6; }
  .live-icon.voltage { color: #10b981; }
  .live-icon.current { color: #f59e0b; }
  .live-icon.cost { color: #ef4444; }

  .live-label {
    color: #94a3b8;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .live-value {
    font-size: 4rem;
    font-weight: 700;
    color: #f1f5f9;
    line-height: 1;
    margin-bottom: 0.5rem;
    font-family: 'Courier New', monospace;
  }

  .live-unit {
    color: #64748b;
    font-size: 1.25rem;
  }

  .live-subtext {
    color: #64748b;
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .status-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .status-icon {
    width: 50px;
    height: 50px;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }

  .status-info {
    flex: 1;
  }

  .status-label {
    color: #94a3b8;
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
  }

  .status-value {
    color: #f1f5f9;
    font-size: 1.25rem;
    font-weight: 700;
  }

  .mini-chart {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1.5rem;
  }

  .mini-chart h3 {
    color: #f1f5f9;
    font-size: 1.25rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .chart-container {
    height: 200px;
  }

  .alert-banner {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 1rem;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    animation: slideDown 0.5s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert-banner i {
    font-size: 2rem;
    color: #ef4444;
  }

  .alert-banner-content {
    flex: 1;
  }

  .alert-banner-title {
    color: #fca5a5;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
  }

  .alert-banner-text {
    color: #fecaca;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .live-value {
      font-size: 3rem;
    }

    .main-display {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="live-container">
  <div class="live-header">
    <div class="live-title">
      <div class="pulse-dot"></div>
      <h1>{{ sensor.name }}</h1>
    </div>
    <div class="refresh-info">
      <i class="fas fa-sync-alt"></i> Odświeżanie co {{ refresh_interval }}s
    </div>
  </div>

  <!-- Alert banner (pokazuje się gdy moc przekracza próg) -->
  <div id="alertBanner" style="display: none;" class="alert-banner">
    <i class="fas fa-exclamation-triangle"></i>
    <div class="alert-banner-content">
      <div class="alert-banner-title">Przekroczono próg mocy!</div>
      <div class="alert-banner-text">Aktualna moc: <span id="alertPower">0</span> W (Próg: {{ sensor.power_threshold|default:"nie ustawiono" }} W)</div>
    </div>
  </div>

  <!-- Główne wyświetlacze -->
  <div class="main-display">
    <div class="live-card" id="powerCard">
      <div class="live-icon power">
        <i class="fas fa-bolt"></i>
      </div>
      <div class="live-label">Moc czynna</div>
      <div class="live-value" id="powerValue">---</div>
      <div class="live-unit">W</div>
      <div class="live-subtext">
        <span id="costPerHour">0.00</span> PLN/h
      </div>
    </div>

    <div class="live-card" id="voltageCard">
      <div class="live-icon voltage">
        <i class="fas fa-plug"></i>
      </div>
      <div class="live-label">Napięcie</div>
      <div class="live-value" id="voltageValue">---</div>
      <div class="live-unit">V</div>
    </div>

    <div class="live-card" id="currentCard">
      <div class="live-icon current">
        <i class="fas fa-wave-square"></i>
      </div>
      <div class="live-label">Prąd</div>
      <div class="live-value" id="currentValue">---</div>
      <div class="live-unit">A</div>
    </div>

    <div class="live-card" id="costCard">
      <div class="live-icon cost">
        <i class="fas fa-dollar-sign"></i>
      </div>
      <div class="live-label">Koszt w czasie rzeczywistym</div>
      <div class="live-value" id="costValue">---</div>
      <div class="live-unit">PLN</div>
      <div class="live-subtext">
        Od startu licznika
      </div>
    </div>
  </div>

  <!-- Status cards -->
  <div class="status-grid">
    <div class="status-card">
      <div class="status-icon">
        <i class="fas fa-tachometer-alt"></i>
      </div>
      <div class="status-info">
        <div class="status-label">Współczynnik mocy</div>
        <div class="status-value" id="pfValue">---</div>
      </div>
    </div>

    <div class="status-card">
      <div class="status-icon">
        <i class="fas fa-heartbeat"></i>
      </div>
      <div class="status-info">
        <div class="status-label">Status</div>
        <div class="status-value" id="statusValue">
          <span style="color: #10b981;">● Online</span>
        </div>
      </div>
    </div>

    <div class="status-card">
      <div class="status-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="status-info">
        <div class="status-label">Ostatni odczyt</div>
        <div class="status-value" id="timestampValue" style="font-size: 0.9rem;">---</div>
      </div>
    </div>
  </div>

  <!-- Mini wykres -->
  <div class="mini-chart">
    <h3><i class="fas fa-chart-area"></i> Historia mocy (ostatnie 20 odczytów)</h3>
    <div class="chart-container">
      <canvas id="miniChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const sensorId = {{ sensor.id }};
  const refreshInterval = {{ refresh_interval }} * 1000;
  const pricePerKwh = {{ sensor.house.price_per_kwh }};
  const powerThreshold = {{ sensor.power_threshold|default:"null" }};
  
  let powerHistory = [];
  let timeHistory = [];
  let totalEnergy = 0;  // kWh
  let startTime = Date.now();

  // Inicjalizuj wykres
  const ctx = document.getElementById('miniChart').getContext('2d');
  const miniChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Moc (W)',
        data: [],
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          grid: { color: '#334155' },
          ticks: { color: '#94a3b8', maxRotation: 0 }
        },
        y: {
          grid: { color: '#334155' },
          ticks: { color: '#94a3b8' }
        }
      }
    }
  });

  async function updateLiveData() {
    try {
      const response = await fetch(`/api/user/sensor/${sensorId}/live/`);
      if (!response.ok) throw new Error('Network error');
      
      const data = await response.json();
      
      // Animacja update
      ['powerCard', 'voltageCard', 'currentCard', 'costCard'].forEach(id => {
        document.getElementById(id).classList.add('updating');
        setTimeout(() => {
          document.getElementById(id).classList.remove('updating');
        }, 300);
      });
      
      // Update wartości
      document.getElementById('powerValue').textContent = data.power ? data.power.toFixed(0) : '---';
      document.getElementById('voltageValue').textContent = data.voltage ? data.voltage.toFixed(1) : '---';
      document.getElementById('currentValue').textContent = data.current ? data.current.toFixed(2) : '---';
      document.getElementById('pfValue').textContent = data.pf ? data.pf.toFixed(2) : '---';
      
      // Koszt per hour
      const costPerHour = data.power ? (data.power * pricePerKwh / 1000).toFixed(3) : '0.00';
      document.getElementById('costPerHour').textContent = costPerHour;
      
      // Całkowity koszt od startu
      if (data.power && powerHistory.length > 0) {
        const timeDiff = (Date.now() - startTime) / 1000 / 3600;  // hours
        const avgPower = powerHistory.reduce((a, b) => a + b, 0) / powerHistory.length;
        totalEnergy = avgPower * timeDiff / 1000;  // kWh
        const totalCost = totalEnergy * pricePerKwh;
        document.getElementById('costValue').textContent = totalCost.toFixed(2);
      }
      
      // Timestamp
      const ts = new Date(data.timestamp);
      document.getElementById('timestampValue').textContent = ts.toLocaleTimeString('pl-PL');
      
      // Status
      document.getElementById('statusValue').innerHTML = data.is_online 
        ? '<span style="color: #10b981;">● Online</span>'
        : '<span style="color: #ef4444;">● Offline</span>';
      
      // Alert o przekroczeniu progu
      if (powerThreshold && data.power > powerThreshold) {
        document.getElementById('alertBanner').style.display = 'flex';
        document.getElementById('alertPower').textContent = data.power.toFixed(0);
      } else {
        document.getElementById('alertBanner').style.display = 'none';
      }
      
      // Update wykresu
      if (data.power) {
        powerHistory.push(data.power);
        timeHistory.push(ts.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }));
        
        if (powerHistory.length > 20) {
          powerHistory.shift();
          timeHistory.shift();
        }
        
        miniChart.data.labels = timeHistory;
        miniChart.data.datasets[0].data = powerHistory;
        miniChart.update('none');
      }
      
    } catch (error) {
      console.error('Błąd aktualizacji:', error);
      document.getElementById('statusValue').innerHTML = '<span style="color: #ef4444;">● Error</span>';
    }
  }

  // Start
  updateLiveData();
  setInterval(updateLiveData, refreshInterval);
</script>
{% endblock %}