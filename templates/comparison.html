{% extends 'base.html' %}

{% block title %}Porównania - {{ house.name }}{% endblock %}

{% block extra_css %}
<style>
  .comparison-header {
    margin-bottom: 2rem;
    animation: fadeIn 0.6s ease-out;
  }

  .comparison-header h1 {
    font-size: 2rem;
    color: #f1f5f9;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .comparison-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid #334155;
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .comparison-card:hover {
    transform: translateY(-4px);
    border-color: #3b82f6;
    box-shadow: 0 12px 24px rgba(59, 130, 246, 0.2);
  }

  .comparison-title {
    color: #94a3b8;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .comparison-values {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .value-item {
    text-align: center;
  }

  .value-label {
    color: #64748b;
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
  }

  .value-number {
    color: #f1f5f9;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .change-indicator {
    text-align: center;
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-weight: 600;
  }

  .change-indicator.positive {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .change-indicator.negative {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }

  .change-indicator.neutral {
    background: rgba(148, 163, 184, 0.1);
    color: #94a3b8;
  }

  .prediction-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .prediction-header h2 {
    color: #f1f5f9;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .prediction-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .prediction-item {
    background: rgba(15, 23, 42, 0.6);
    padding: 1.25rem;
    border-radius: 0.75rem;
    border: 1px solid #334155;
  }

  .prediction-item label {
    color: #94a3b8;
    font-size: 0.85rem;
    display: block;
    margin-bottom: 0.5rem;
  }

  .prediction-item .value {
    color: #f59e0b;
    font-size: 2rem;
    font-weight: 700;
  }

  .ranking-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .ranking-header {
    color: #f1f5f9;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .ranking-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .ranking-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 0.75rem;
    border: 1px solid #334155;
    transition: all 0.3s ease;
  }

  .ranking-item:hover {
    background: rgba(59, 130, 246, 0.05);
    border-color: #3b82f6;
  }

  .rank-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .rank-number.top1 {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  }

  .rank-number.top2 {
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
  }

  .rank-number.top3 {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  }

  .rank-info {
    flex: 1;
  }

  .rank-name {
    color: #f1f5f9;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .rank-location {
    color: #64748b;
    font-size: 0.9rem;
  }

  .rank-value {
    text-align: right;
  }

  .rank-kwh {
    color: #3b82f6;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .rank-cost {
    color: #94a3b8;
    font-size: 0.9rem;
  }

  .chart-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 2rem;
  }

  .chart-header {
    color: #f1f5f9;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .chart-container {
    height: 400px;
  }
</style>
{% endblock %}

{% block content %}
<div class="comparison-header">
  <h1><i class="fas fa-chart-bar"></i> Porównania i statystyki - {{ house.name }}</h1>
</div>

<div class="comparison-grid">
  <div class="comparison-card">
    <div class="comparison-title">
      <i class="fas fa-calendar-day"></i>
      Dziś vs Wczoraj
    </div>
    <div class="comparison-values">
      <div class="value-item">
        <div class="value-label">Dziś</div>
        <div class="value-number">{{ day_comparison.current|floatformat:1 }}</div>
        <div style="color: #64748b; font-size: 0.8rem;">kWh</div>
      </div>
      <div class="value-item">
        <div class="value-label">Wczoraj</div>
        <div class="value-number">{{ day_comparison.previous|floatformat:1 }}</div>
        <div style="color: #64748b; font-size: 0.8rem;">kWh</div>
      </div>
    </div>
    <div class="change-indicator {% if day_comparison.change_percent > 0 %}positive{% elif day_comparison.change_percent < 0 %}negative{% else %}neutral{% endif %}">
      {% if day_comparison.change_percent > 0 %}
        <i class="fas fa-arrow-up"></i> +{{ day_comparison.change_percent|floatformat:1 }}%
      {% elif day_comparison.change_percent < 0 %}
        <i class="fas fa-arrow-down"></i> {{ day_comparison.change_percent|floatformat:1 }}%
      {% else %}
        <i class="fas fa-equals"></i> Bez zmian
      {% endif %}
    </div>
  </div>

  <div class="comparison-card">
    <div class="comparison-title">
      <i class="fas fa-calendar-week"></i>
      Ten tydzień vs Poprzedni
    </div>
    <div class="comparison-values">
      <div class="value-item">
        <div class="value-label">Ten tydzień</div>
        <div class="value-number">{{ week_comparison.current|floatformat:1 }}</div>
        <div style="color: #64748b; font-size: 0.8rem;">kWh</div>
      </div>
      <div class="value-item">
        <div class="value-label">Poprzedni</div>
        <div class="value-number">{{ week_comparison.previous|floatformat:1 }}</div>
        <div style="color: #64748b; font-size: 0.8rem;">kWh</div>
      </div>
    </div>
    <div class="change-indicator {% if week_comparison.change_percent > 0 %}positive{% elif week_comparison.change_percent < 0 %}negative{% else %}neutral{% endif %}">
      {% if week_comparison.change_percent > 0 %}
        <i class="fas fa-arrow-up"></i> +{{ week_comparison.change_percent|floatformat:1 }}%
      {% elif week_comparison.change_percent < 0 %}
        <i class="fas fa-arrow-down"></i> {{ week_comparison.change_percent|floatformat:1 }}%
      {% else %}
        <i class="fas fa-equals"></i> Bez zmian
      {% endif %}
    </div>
  </div>

  <div class="comparison-card">
    <div class="comparison-title">
      <i class="fas fa-calendar-alt"></i>
      Ten miesiąc vs Poprzedni
    </div>
    <div class="comparison-values">
      <div class="value-item">
        <div class="value-label">Ten miesiąc</div>
        <div class="value-number">{{ month_comparison.current|floatformat:1 }}</div>
        <div style="color: #64748b; font-size: 0.8rem;">kWh</div>
      </div>
      <div class="value-item">
        <div class="value-label">Poprzedni</div>
        <div class="value-number">{{ month_comparison.previous|floatformat:1 }}</div>
        <div style="color: #64748b; font-size: 0.8rem;">kWh</div>
      </div>
    </div>
    <div class="change-indicator {% if month_comparison.change_percent > 0 %}positive{% elif month_comparison.change_percent < 0 %}negative{% else %}neutral{% endif %}">
      {% if month_comparison.change_percent > 0 %}
        <i class="fas fa-arrow-up"></i> +{{ month_comparison.change_percent|floatformat:1 }}%
      {% elif month_comparison.change_percent < 0 %}
        <i class="fas fa-arrow-down"></i> {{ month_comparison.change_percent|floatformat:1 }}%
      {% else %}
        <i class="fas fa-equals"></i> Bez zmian
      {% endif %}
    </div>
  </div>
</div>

<div class="prediction-section">
  <div class="prediction-header">
    <h2><i class="fas fa-crystal-ball"></i> Predykcja końca miesiąca</h2>
  </div>
  <div class="prediction-grid">
    <div class="prediction-item">
      <label>Przewidywane zużycie</label>
      <div class="value">{{ prediction.predicted_kwh|floatformat:1 }} kWh</div>
    </div>
    <div class="prediction-item">
      <label>Przewidywany koszt</label>
      <div class="value">{{ prediction.predicted_cost|floatformat:2 }} PLN</div>
    </div>
    <div class="prediction-item">
      <label>Średnia dzienna</label>
      <div class="value">{{ prediction.daily_average|floatformat:1 }} kWh</div>
    </div>
    <div class="prediction-item">
      <label>Dni pozostało</label>
      <div class="value">{{ prediction.days_remaining|floatformat:1 }}</div>
    </div>
  </div>
</div>

<div class="ranking-section">
  <h2 class="ranking-header">
    <i class="fas fa-trophy"></i>
    Ranking czujników (zużycie w miesiącu)
  </h2>
  <div class="ranking-list">
    {% for item in sensor_rankings %}
    <div class="ranking-item">
      <div class="rank-number {% if forloop.counter == 1 %}top1{% elif forloop.counter == 2 %}top2{% elif forloop.counter == 3 %}top3{% endif %}">
        {{ forloop.counter }}
      </div>
      <div class="rank-info">
        <div class="rank-name">{{ item.sensor.name }}</div>
        <div class="rank-location">
          {% if item.sensor.location %}
            <i class="fas fa-map-marker-alt"></i> {{ item.sensor.location }}
          {% else %}
            {{ item.sensor.house.name }}
          {% endif %}
        </div>
      </div>
      <div class="rank-value">
        <div class="rank-kwh">{{ item.kwh }} kWh</div>
        <div class="rank-cost">{{ item.cost|floatformat:2 }} PLN</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div class="chart-section">
  <h2 class="chart-header">
    <i class="fas fa-chart-line"></i>
    Historia 12 miesięcy
  </h2>
  <div class="chart-container">
    <canvas id="monthlyChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Zabezpieczenie przed błędem, gdy dane nie są JSON (np. błąd 500)
  let monthlyData;
  try {
    monthlyData = JSON.parse('{{ monthly_history|safe|escapejs }}');
  } catch (e) {
    monthlyData = [];
    console.error("Nie można załadować danych historycznych:", e);
  }
  
  const ctx = document.getElementById('monthlyChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthlyData.map(d => d.month),
      datasets: [{
        label: 'Zużycie (kWh)',
        data: monthlyData.map(d => d.kwh),
        backgroundColor: 'rgba(59, 130, 246, 0.5)',
        borderColor: '#3b82f6',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#f1f5f9'
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: '#334155'
          },
          ticks: {
            color: '#94a3b8'
          }
        },
        y: {
          grid: {
            color: '#334155'
          },
          ticks: {
            color: '#94a3b8'
          }
        }
      }
    }
  });
</script>
{% endblock %}
